{% extends "base.html" %}

{% block title %}Transcription History - Transcription Bot{% endblock %}

{% block extra_css %}
<style>
    .balance-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
    }

    .balance-header h3 {
        margin-bottom: 8px;
    }

    .balance-header p {
        opacity: 0.9;
        margin-top: 8px;
    }

    .transcriptions-grid {
        display: grid;
        gap: 18px;
    }

    .transcription-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
        gap: 15px;
    }

    .card-info h3 {
        margin-bottom: 5px;
        font-size: 18px;
    }

    .card-meta {
        color: #666;
        font-size: 14px;
    }

    .card-status {
        text-align: right;
        flex-shrink: 0;
    }

    .status-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 14px;
        white-space: nowrap;
    }

    .card-cost {
        margin-top: 10px;
        font-weight: bold;
        color: #667eea;
    }

    .transcription-preview {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .transcription-preview p {
        white-space: pre-wrap;
        line-height: 1.6;
        max-height: 100px;
        overflow: hidden;
        margin: 0;
    }

    .empty-state {
        text-align: center;
        padding: 50px 20px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .empty-icon {
        font-size: 64px;
        margin-bottom: 18px;
    }

    .empty-state h2 {
        margin-bottom: 10px;
    }

    .empty-state p {
        color: #666;
        margin-bottom: 25px;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }

    .modal-content {
        position: relative;
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 800px;
        width: 90%;
        margin: 50px auto;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }

    .modal-header {
        margin-bottom: 20px;
    }

    .modal-body {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .modal-text {
        white-space: pre-wrap;
        font-family: inherit;
        line-height: 1.6;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    @media screen and (max-width: 768px) {
        .balance-header {
            padding: 15px;
            margin-bottom: 20px;
        }

        .balance-header h3 {
            font-size: 18px;
        }

        .transcriptions-grid {
            gap: 15px;
        }

        .transcription-card {
            padding: 15px;
        }

        .card-header {
            flex-direction: column;
            gap: 12px;
        }

        .card-info h3 {
            font-size: 16px;
        }

        .card-meta {
            font-size: 13px;
        }

        .card-status {
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .status-badge {
            padding: 4px 12px;
            font-size: 13px;
        }

        .transcription-preview {
            padding: 12px;
        }

        .transcription-preview p {
            font-size: 14px;
        }

        .empty-state {
            padding: 40px 15px;
        }

        .empty-icon {
            font-size: 56px;
        }

        .modal-content {
            padding: 20px;
            width: 95%;
            margin: 20px auto;
            max-height: calc(100vh - 40px);
        }

        .modal-body {
            padding: 15px;
        }

        .modal-actions {
            gap: 10px;
        }

        .modal-actions .btn {
            flex: 1;
            min-width: calc(50% - 5px);
        }
    }

    @media screen and (max-width: 480px) {
        .balance-header {
            padding: 12px;
        }

        .balance-header h3 {
            font-size: 16px;
        }

        .transcription-card {
            padding: 12px;
        }

        .card-info h3 {
            font-size: 15px;
        }

        .card-meta {
            font-size: 12px;
        }

        .status-badge {
            font-size: 12px;
            padding: 4px 10px;
        }

        .card-cost {
            font-size: 14px;
        }

        .transcription-preview {
            padding: 10px;
        }

        .transcription-preview p {
            font-size: 13px;
        }

        .empty-state {
            padding: 30px 10px;
        }

        .empty-icon {
            font-size: 48px;
        }

        .modal-content {
            padding: 15px;
        }

        .modal-header h2 {
            font-size: 18px;
        }

        .modal-body {
            padding: 12px;
        }

        .modal-text {
            font-size: 14px;
        }

        .modal-actions .btn {
            min-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 20px;">Transcription History</h1>

<div class="balance-header">
    <h3>Your Balance: {{ wallet.balance|default:0|floatformat:2 }} UZS</h3>
    <p>Total Transcriptions: {{ transcriptions|length }}</p>
</div>

{% if transcriptions %}
    <div class="transcriptions-grid">
    {% for t in transcriptions %}
        <div class="transcription-card">
            <div class="card-header">
                <div class="card-info">
                    <h3>
                        {% if t.file_type == 'audio' %}üéµ{% else %}üé¨{% endif %}
                        {{ t.file_name|default:"Unnamed File" }}
                    </h3>
                    <p class="card-meta">
                        {{ t.created_at|date:"Y-m-d H:i" }} ‚Ä¢
                        {{ t.file_type|capfirst }} ‚Ä¢
                        {{ t.file_size|filesizeformat }} ‚Ä¢
                        <span class="duration-{{ t.id }}">{{ t.duration_seconds|floatformat:0 }}s</span>
                    </p>
                </div>
                <div class="card-status">
                    <span class="status-badge" style="background: {% if t.status == 'completed' %}#d4edda{% else %}#fff3cd{% endif %};
                                 color: {% if t.status == 'completed' %}#155724{% else %}#856404{% endif %};">
                        {{ t.status|capfirst }}
                    </span>
                    <p class="card-cost">
                        {{ t.cost|floatformat:2 }} UZS
                    </p>
                </div>
            </div>

            <div class="transcription-preview">
                <p>{{ t.transcription_text|truncatechars:300 }}</p>
            </div>

            <div style="display: none;" id="full-text-{{ t.id }}">{{ t.transcription_text }}</div>

            <div>
                <button class="btn" onclick="viewTranscription({{ t.id }})">
                    View Full Text
                </button>
            </div>
        </div>
    {% endfor %}
    </div>
{% else %}
    <div class="empty-state">
        <div class="empty-icon">üìù</div>
        <h2>No Transcriptions Yet</h2>
        <p>Start by uploading your first audio or video file!</p>
        <a href="/upload" class="btn">Upload File</a>
    </div>
{% endif %}

<!-- Modal for viewing full transcription -->
<div id="modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Full Transcription</h2>
        </div>
        <div class="modal-body">
            <pre id="modal-text" class="modal-text"></pre>
        </div>
        <div class="modal-actions">
            <button class="btn" onclick="downloadModalText()">üì• Download</button>
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<script>
    let currentTranscriptionText = '';
    let currentTranscriptionId = null;

    // Check if running in Telegram WebApp
    const isTelegramWebApp = window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData;

    // Format durations on page load
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[class^="duration-"]').forEach(function(elem) {
            const seconds = parseInt(elem.textContent);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            elem.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        });
    });

    function viewTranscription(id) {
        const text = document.getElementById('full-text-' + id).textContent;
        currentTranscriptionText = text;
        currentTranscriptionId = id;
        document.getElementById('modal-text').textContent = text;
        document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function downloadModalText() {
        if (!currentTranscriptionId) {
            alert('Error: No transcription selected');
            return;
        }

        const downloadUrl = `/api/download/${currentTranscriptionId}/`;

        if (isTelegramWebApp) {
            // In Telegram WebApp, open download link in external browser
            window.Telegram.WebApp.openLink(window.location.origin + downloadUrl);

            // Show feedback
            if (window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
        } else {
            // In regular browser, just navigate to download URL
            window.location.href = downloadUrl;
        }
    }

    // Close modal when clicking outside
    document.getElementById('modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}
